#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: $0 --older-than <days> [--delete | --dry-run] [repo_path]"
  echo ""
  echo "Examples:"
  echo "  $0 --older-than 60"
  echo "  $0 --older-than 60 --dry-run"
  echo "  $0 --older-than 60 --delete ../my-repo"
  exit 1
}

if [[ $# -lt 2 ]]; then
  usage
fi

DELETE=false
DRY_RUN=false

if [[ "$1" != "--older-than" ]]; then
  echo "Error: --older-than flag is required"
  usage
fi

DAYS="$2"
shift 2

if ! [[ "$DAYS" =~ ^[0-9]+$ ]]; then
  echo "Error: <days> must be a positive integer"
  exit 1
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --delete)
      DELETE=true
      ;;
    --dry-run)
      DRY_RUN=true
      ;;
    *)
      REPO_PATH="$1"
      ;;
  esac
  shift
done

REPO_PATH="${REPO_PATH:-.}"

if [[ "$DELETE" == true && "$DRY_RUN" == true ]]; then
  echo "Error: Cannot use --delete and --dry-run together"
  exit 1
fi

cd "$REPO_PATH" 2>/dev/null || {
  echo "Error: Could not access repo at $REPO_PATH"
  exit 1
}

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "Error: $REPO_PATH is not a git repository"
  exit 1
fi

CUTOFF=$(date -v -"${DAYS}"d +%s)
CURRENT=$(git branch --show-current)

echo ""
echo "Branches older than $DAYS days in $REPO_PATH:"
echo ""

STALE_BRANCHES=()

while read branch commit_ts; do
  if [[ -n "$commit_ts" && "$branch" != "$CURRENT" && "$commit_ts" -lt "$CUTOFF" ]]; then
    STALE_BRANCHES+=("$branch")
  fi
done < <(git for-each-ref --format='%(refname:short) %(committerdate:unix)' refs/heads)

if [[ ${#STALE_BRANCHES[@]} -eq 0 ]]; then
  echo "No stale branches found."
  exit 0
fi

for branch in "${STALE_BRANCHES[@]}"; do
  last_commit_date=$(git log -1 --format="%cd" --date=format:"%Y-%m-%d" "$branch")
  printf "%-35s %s\n" "$branch" "$last_commit_date"
done | sort

echo ""
echo "Total stale branches: ${#STALE_BRANCHES[@]}"
echo ""

if [[ "$DRY_RUN" == true ]]; then
  echo "Dry run enabled. No branches were deleted."
  exit 0
fi

if [[ "$DELETE" == true ]]; then
  echo "Deleting stale branches..."
  for branch in "${STALE_BRANCHES[@]}"; do
    git branch -D "$branch"
  done
  echo "Deleted ${#STALE_BRANCHES[@]} branches."
fi
