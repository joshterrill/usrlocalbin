#!/usr/bin/env bash

set -euo pipefail

usage() {
  echo "Usage: $0 --older-than <days> [repo_path]"
  echo ""
  echo "Example:"
  echo "  $0 --older-than 60"
  echo "  $0 --older-than 45 ../my-repo"
  exit 1
}

if [[ $# -lt 2 ]]; then
  usage
fi

if [[ "$1" != "--older-than" ]]; then
  echo "Error: --older-than flag is required"
  usage
fi

DAYS="$2"

if ! [[ "$DAYS" =~ ^[0-9]+$ ]]; then
  echo "Error: <days> must be a positive integer"
  exit 1
fi

REPO_PATH="${3:-.}"

cd "$REPO_PATH" 2>/dev/null || {
  echo "Error: Could not access repo at $REPO_PATH"
  exit 1
}

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "Error: $REPO_PATH is not a git repository"
  exit 1
fi

# macOS-compatible cutoff (BSD date)
CUTOFF=$(date -v -"${DAYS}"d +%s)

echo ""
echo "Branches older than $DAYS days in $REPO_PATH:"
echo ""

CURRENT=$(git branch --show-current)

git for-each-ref --format='%(refname:short) %(committerdate:unix)' refs/heads | \
while read branch commit_ts; do
  if [[ -n "$commit_ts" && "$branch" != "$CURRENT" && "$commit_ts" -lt "$CUTOFF" ]]; then
    last_commit_date=$(date -r "$commit_ts" +"%Y-%m-%d")
    printf "%-35s %s\n" "$branch" "$last_commit_date"
  fi
done | sort
